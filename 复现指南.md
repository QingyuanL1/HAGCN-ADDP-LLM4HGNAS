# 复现指南 (Reproduction Guide)

本指南旨在帮助研究人员复现 **LLM-driven Architecture Search for APDP** 的实验结果。

## 1. 环境准备

确保您的环境满足 `README.md` 中的依赖要求。推荐使用 `conda` 创建环境：

```bash
conda create -n apdp_nas python=3.10
conda activate apdp_nas
pip install torch numpy tqdm tensorboard_logger
# 如果使用 LLM 功能，不需要额外安装 openai 包，代码使用原生 urllib
```

## 2. 实验复现步骤

我们比较两种主要设置：**纯随机搜索 (Random)** 与 **LLM 驱动搜索 (GPT-4)**。

### 实验 A: LLM 驱动的架构搜索 (推荐)

此模式启用 GPT-4 根据历史性能反馈优化架构。

**运行命令 (主要为 Windows 优化，单行命令):**
```bash
python run.py --problem pdp --graph_size 20 --baseline rollout --epoch_size 12800 --n_epochs 50 --nas_enabled --nas_arch_generator llm --llm_model gpt-4 --llm_api_key "YOUR_KEY_HERE" --llm_base_url "https://aihubmix.com/v1" --run_name nas_gpt4_exp
```

*(如果您在 Linux/Mac 下，可以使用反斜杠 `\` 换行，但在 Windows CMD 中请使用单行，或使用 `^` 换行)*

### 实验 B: 随机搜索基线 (Baseline)

此模式完全随机生成架构，用于验证 LLM 搜索的有效性。

**运行命令 (单行):**
```bash
python run.py --problem pdp --graph_size 20 --baseline rollout --epoch_size 12800 --n_epochs 50 --nas_enabled --nas_arch_generator random --run_name nas_random_exp
```

## 3. 结果分析

实验运行后，会在 `outputs/pdp_20/` 目录下生成对应的运行文件夹。关键文件是 `nas_history.json`。

### 分析指标
1.  **Cost (验证集代价)**: 越低越好。这是衡量架构性能的核心指标。
2.  **Architecture (架构多样性)**: 检查 `arch` 字段。
    *   **算子代码**:
        *   `0`: Zero (剪枝)
        *   `1`: Attention (传统方法)
        *   `2`: GCN
        *   `3`: GAT
        *   `4`: MLP
    *   **LLM 有效性指标**: 随着 Epoch 增加，LLM 组生成的架构应该收敛到更低的 Cost，且算子组合应体现出非随机的模式（例如在某些特定关系上倾向于用 GAT）。

### 示例数据结构
```json
{
  "best": {
    "arch": [[3, 2, ...], ...],
    "val_cost": 52.15,
    "epoch": 45
  },
  "history": [
    {
      "epoch": 0,
      "arch": [[1, 0, ...], ...],
      "val_cost": 59.19
    },
    ...
  ]
}
```

## 4. 常见问题 (Troubleshooting)

*   **LLM 生成失败**: 检查 `OPENAI_API_KEY` 是否正确，或 Account 是否有余额。代码会自动重试，若多次失败则回退到 Random。
*   **显存不足 (OOM)**: 尝试减小 `--batch_size` (默认 512，可改为 256)。
*   **维度错误 (RuntimeError)**: 确保使用了最新版的 `nets/graph_encoder.py`，其中修复了 GAT 算子的广播维度问题。

## 5. 关键参数说明 (Arguments)

| 参数 (Argument) | 默认值 (Default) | 说明 (Description) |
| :--- | :--- | :--- |
| `--problem` | `pdp` | 问题类型，目前支持取送货问题 (PDP)。 |
| `--graph_size` | `20` | 图规模（节点数），实验常用 20 或 50。 |
| `--nas_enabled` | `False` | **[核心]** 是否开启架构搜索 (NAS) 模式。开启后会动态切换 Encoder 架构。 |
| `--nas_arch_generator` | `llm` | 架构生成器类型。`llm` 使用 GPT-4；`random` 使用随机生成。 |
| `--llm_model` | `gpt-4-0314` | 使用的具体 LLM 模型版本。建议使用 `gpt-4` 以获得最佳推理效果。 |
| `--llm_api_key` | `None` | OpenAI API Key。必填，否则无法调用 LLM。 |
| `--llm_base_url` | `https://api.openai.com/v1` | LLM API 的基础地址。如果使用中转服务（如 AiHubMix），请在此指定。 |
| `--arch_switch_interval` | `10` | 架构切换频率。即每训练多少个 Epoch 后生成一个新架构。 |
| `--epoch_size` | `51200` | 每个 Epoch 训练生成的样本数量。设为 `12800` 可加快实验迭代速度。 |
| `--baseline` | `rollout` | 强化学习的基线策略。`rollout` 通常比 `exponential` 更稳定但较慢。 |

